<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>AI Nutrition Analyzer</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Loading spinner */
        #loading {
            display: none;
            text-align: center;
            margin-top: 1.5rem;
        }
        .spinner {
            border: 4px solid #eee;
            border-top: 4px solid #4CAF50;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: auto;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to   { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
<div class="container">
    <h1>AI Nutrition Analysis Tool</h1>

    <form id="calorie-form">
        <div class="form-group">
            <label for="food">Food name</label>
            <input type="text" id="food" name="food" placeholder="e.g. Bubble milk tea" required>
        </div>

        <div class="form-group">
            <label for="amount">Amount</label>
            <input type="text" id="amount" name="amount" placeholder="e.g. half cup, one serving" required>
        </div>

        <button type="submit">Analyze</button>
    </form>

    <!-- Loading indicator -->
    <div id="loading">
        <div class="spinner"></div>
        <p>Analyzing...</p>
    </div>

    <!-- 主要結果區 -->
    <div id="result-area"></div>
</div>


<script>
document.getElementById("calorie-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const food = document.getElementById("food").value;
    const amount = document.getElementById("amount").value;

    // 顯示 loading
    document.getElementById("loading").style.display = "block";

    // 清除舊結果
    document.getElementById("result-area").innerHTML = "";

    const response = await fetch("/calculate", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `food=${encodeURIComponent(food)}&amount=${encodeURIComponent(amount)}`
    });

    const data = await response.json();

    // 隱藏 loading
    document.getElementById("loading").style.display = "none";

    console.log("LLM JSON:", data);

    // 顯示結果包含 JSON + 圓餅圖
    document.getElementById("result-area").innerHTML = `
        <h3>Nutrition Breakdown</h3>

        <div id="json-output">
            <p><b>Calories:</b> ${data.calories}</p>
            <p><b>Protein:</b> ${data.protein}</p>
            <p><b>Fat:</b> ${data.fat}</p>
            <p><b>Carbs:</b> ${data.carbs}</p>
            <p><b>Suggestion:</b> ${data.suggestion}</p>
        </div>

        <canvas id="nutritionChart" width="200" height="200" style="max-width:200px; margin:auto;"></canvas>
    `;

    // 解析 "10-20 g" → 數值
    function avg(v) {
        if (!v) return 0;
        const nums = v.replace(/[^\d.-]/g, "").split("-").map(Number);
        return nums.length === 2 ? (nums[0] + nums[1]) / 2 : nums[0];
    }

    const protein = avg(data.protein);
    const fat = avg(data.fat);
    const carbs = avg(data.carbs);

    const ctx = document.getElementById("nutritionChart").getContext("2d");

    new Chart(ctx, {
        type: "pie",
        data: {
            labels: ["Protein", "Fat", "Carbs"],
            datasets: [{
                data: [protein, fat, carbs],
                backgroundColor: ["#4CAF50", "#FF9800", "#2196F3"]
            }]
        }
    });
});
</script>
</body>
</html>
